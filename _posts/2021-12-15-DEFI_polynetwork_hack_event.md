---
layout: post
title: The Largest Hack Incident in DeFi's History- Polynetwork Exploit
category: programming
---
### The Incident
On August 10th, 2021, Poly Network was attacked by anonymous white hat hacker or hackers, causing over $610 million in digital crypto assets at the price of that date to be transferred to hacker-controlled addresses. Eventually, all assets were returned to Poly Network over the next 15 days. This was the largest security incident in DeFi's history in terms of the value of stolen assets at the price of that date.

Stolen Assets:


| Name | NETWORK | AMOUNT |   
| --- | --- | --- |
| Ethereum | USDC | 96m$ |
| Ethereum | WBTC | 1,032 (50m$) |
| Ethereum | DAI  | 0.67m$ |
| Ethereum | USDT | 33m$   |
| Ethereum | ETH  | 28,966 （111m$）|
| Binance  | USDC | 87m$ |
| Binance  | BUSD | 32m$ |
| Polygon  | USDC | 85m$ |


...
### News: 
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146314501-30ab8068-a0a0-480a-a170-5c7e99fa2cd7.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146314315-3cb83474-eb87-406d-a249-b6a28ffe05b3.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146314388-55b73706-5f0c-4883-a2e5-d59e468a9d64.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146314476-2e5c1c82-4b3e-4cda-b351-608ef48a998e.png">


[Wiki](https://en.wikipedia.org/wiki/Poly_Network_exploit)

### What is Cross Chain and Polynetwork
#### Why to Cross Chain
1. Cross Chain Farm: Transfer your USDT from ETH to BSC to farm; O3Swap;
2. Hidden your money: Address replaced; from BSC, Polygon to ETH to prevent controlled fork;
#### How Polynetwork Works
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146582558-42774ce9-b80b-4472-a16d-1edc07ad475a.png">

The Big Graph
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146317676-621a25e6-c8b6-498a-8ef5-994d3889cd2e.png">

The Details
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146317735-3d6cb848-018b-4fc3-9474-c74fd3fb55b9.png">

### Incident Timeline
1. 2021.08.10 Call USDT/USDC/ to blacklist hacker's address;
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583134-7ff43bde-1e39-4abb-89d7-fcd37f1debae.png">

2. O3 announced;
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583356-d93f6f81-e453-474d-a3c2-0afe04812a72.png">

3. Hacker use stoled assets to Farm to earn;
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583525-7ab75506-80df-4281-8b2f-fe57858ce04d.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146584571-db237c7d-ac83-49be-b4ac-6ccaf7a32b52.png">

Security Teams tried to find the cause: some guess private key stolen, Certik is the first one, SlowMist is the second.

4. BSC/HB take actions;
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583639-2a9acffa-d39f-4de9-9bb3-5d6fd11003d0.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583712-28a090fc-e93a-482e-a0bd-046ebebe4965.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583771-7899b78f-f779-4e76-9dea-9bc73d4df691.png">

5. Hacker SHOW: [Transaction](https://etherscan.io/txs?a=0xc8a65fadf0e0ddaf421f28feab69bf6e2e589963&f=2&p=2)
Use tonado to Wash Money:
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146584748-8eb0358a-b6c3-4f87-baa1-c5d740a1bca0.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146587035-8b21de84-81c2-442f-8ecb-9d5c7d107c33.png">

My Story 1 - 6, from this we can guess the hacker is white hat and not going to stole the money.
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146585034-81071c25-acb3-42c2-bad5-b810bd87ba6a.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146585638-0d7584c5-8b69-4836-b9cd-0b0b570e4617.png">
Story 2: I'm Angry!
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146585973-0a65eb4a-2a50-4f40-b02a-d3347b942984.png">
Defi: Code is Law
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146586166-19a0eec6-00bd-4e31-a57e-6fa5a72d0792.png">
Worldwide Network Begger
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146586271-2f7025b2-6fb6-4631-b3b1-1e89a587a3c4.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146586732-73b2d09c-f7de-4d77-9676-56de77675f2d.png">
Refuse bounty and Return money
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146587270-9c0b8e47-30f2-44e1-8ef6-ffdacc1d39c7.png">

6. Start to Return Money;
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146583997-dd493f2b-373f-4bb1-8972-9528e86ce3ca.png">


### How to Exploit
#### Just Miss One Line Code
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146193244-6b1ff1b9-b5f6-4a88-b638-6ceda8ee5405.png">
[Source code](https://github.com/polynetwork/eth-contracts/blob/master/contracts/core/cross_chain_manager/logic/EthCrossChainManager.sol)
And this will then Call:
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146320580-19c0e4dd-4aba-43e3-8fc3-8747becef5a0.png">
[Source code](https://github.com/christianxiao/eth-contracts/blob/master/contracts/core/cross_chain_manager/data/EthCrossChainData.sol)
**If you can put your own public keys, then you can controll everything.**

#### Details
[Certik is the first one to explain this](https://certik-io.medium.com/polynetwork-hack-analysis-a86513f2a730)
##### First Attack：From ONT
Create a special transaction to Replace Public Key
[transaction](https://explorer.ont.io/tx/F771BA610625D5A37B67D30BF2F8829703540C86AD76542802567CAAFFFF280C#)
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146578747-3fac4b13-3aae-4471-86a1-e0bb99c8ab65.png">
Important Notes:
1. He need to carefully to choose a method name to match the hash of ```putCurEpochConPubKeyBytes``` to attack; “6631313231333138303933” whose signature is equal to 0x41973cd9 (the signature of putCurEpochConPubKeyBytes(bytes))
 <img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146579397-d4e8abc6-9f3b-4149-a084-a5b2fb75a53c.png">
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146579700-38360d06-269c-4987-a0b3-c9b246121d56.png">
2. He need ONG as gas, which can not be bought at DEX, only at CEX, which can be trackable.
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146580222-e2230420-33ca-45d2-a14e-57691b5dd798.png">

#### This Transaction is accepted by Poly Chain
[Transaction](https://explorer.poly.network/tx/1a72a0cf65e4c08bb8aab2c20da0085d7aee3dc69369651e2e08eb798497cc80)

#### Ethereum accepted too
[Transaction](https://etherscan.io/tx/0xb1f70464bd95b774c6ce60fc706eb5f9e35cb5f06e6cfe7c17dcda46ffd59581)
1. EthCrossChainManager.verifyHeaderAndExecuteTx() was triggered:
a. fromChainId: 3 (Side Chain)
b. toChainId: 2 (Target Chain)
c. toContract: 0xcf2afe102057ba5c16f899271045a0a37fcb10f2
d. method: 0x6631313231333138303933
e. args: 010000000000000014a87fb85a93ca072cd4e5f0d4f178bc831df8a00b
<img width=50% height=50% src="https://user-images.githubusercontent.com/4775215/146580838-2dd4d92a-d56a-43e4-85f9-c418da75afdd.png">
2. EthCrossChainManager._executeCrossChainTx() was triggered:
 toContract (0xcf2afe102057ba5c16f899271045a0a37fcb10f2), 
 method (0x6631313231333138303933),
 args (010000000000000014a87fb85a93ca072cd4e5f0d4f178bc831df8a00b)
3. The public key was changed. Done.


### Solutions
1. If you are a hacker, 
2. CEX or Centralised chains are not reliable: they can do hard fork; 
3. You need to buy the gas token, so CEX can trace your IP;  
4. USDT/USDC can blacklist your address;
5. Almost all addresses can be trackble, to CEX; so use Monero and DEX;
6. After that, Tonardo is safe to wash your money;

a. The design of Polynetwork is centralised, if you get the private key, you controll all the money. A hacker or the project owner can hold the private key. How to solve this?
a. Cross chain projects seems unsafe. It seems impossible to build a safe and decentralised cross chain projects.
